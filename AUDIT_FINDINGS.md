# Аудит соответствия Техническому Заданию (ТЗ)

Этот документ описывает расхождения между реализацией и предоставленным ТЗ. Он послужит основой для планирования дальнейших доработок.

## 1. Слой данных (Модели SQLAlchemy)

В целом модели соответствуют DDL из ТЗ. Найдено одно несоответствие.

### 1.1. Модель `Payroll`

- **Расположение:** `src/app/db/models/hr.py`
- **Проблема:** Поле `shifts_count` имеет неверный тип `Numeric(12, 2)`.
- **Ожидание (согласно ТЗ, раздел 9):** Поле должно иметь тип `Integer`, так как является счетчиком отработанных смен.
- **Влияние:** Низкое. Некорректный тип данных, который может привести к ошибкам при работе с целыми числами.

```python
# src/app/db/models/hr.py

class Payroll(Base):
    # ...
    # НЕВЕРНО
    shifts_count: Mapped[int] = mapped_column(
        Numeric(12, 2), nullable=False, server_default="0"
    )
    # ...
```

## 2. Слой контрактов API (Схемы Pydantic)

Схемы в основном корректны, но есть одно упущение в контракте ответа.

### 2.1. Схема ответа на погашение купона

- **Расположение:** `src/app/schemas/promotions.py`
- **Проблема:** Схема `CouponRedeemResponse` не включает в себя объект `client` с обновленными данными (уровень, `total_spent`).
- **Ожидание (согласно ТЗ, раздел 22.4.2):** Ответ должен содержать информацию не только о результате погашения, но и об обновленном состоянии клиента. Это полезно для клиентских приложений (например, рабочего бота), чтобы сразу отобразить новый статус.
- **Влияние:** Среднее. API не предоставляет всех необходимых данных в одном ответе, что может потребовать от клиента дополнительных запросов.

```json
// Ожидаемый ответ в ТЗ
{
  "result": { ... },
  "client": {"id": 1205, "level": 3, "total_spent": 28500.00}
}
```

## 3. Слой бизнес-логики (Сервисы)

Это слой с наибольшим количеством критических несоответствий. Ключевая бизнес-логика не реализована.

### 3.1. `RedemptionService` (Погашение купона)

- **Расположение:** `src/app/services/redemption.py`
- **Проблемы:**
    1.  **Отсутствие проверок условий шаблона:**
        -   **`min_purchase`:** Не проверяется минимальная сумма покупки (ТЗ, раздел 21.2).
        -   **`conditions`:** Не проверяются условия по клиенту (возраст, пол, теги, уровень и т.д.) (ТЗ, раздел 21.2).
    2.  **Отсутствие поддержки многоразовых купонов:**
        -   Не проверяются лимиты `usage_limit` и `per_user_limit` (ТЗ, BR-004, раздел 21.2). Логика всегда помечает купон как `redeemed`.
    3.  **Отсутствие логики стэкинга (суммирования скидок):**
        -   Полностью игнорируются правила `stacking_rules` из шаблона. Применяется только скидка самого купона (ТЗ, раздел 21.3).
    4.  **Отсутствие сценария "покупка без купона":**
        -   Сервис не обрабатывает случай, когда купон не предоставляется, а сотрудник просто фиксирует сумму покупки для начисления прогресса клиенту (ТЗ, UC-005).
    5.  **Некорректная валидация владельца купона:**
        -   Проверка `coupon.client_id != client.id` не позволяет погашать общие (неперсональные) купоны, у которых `client_id IS NULL` (ТЗ, BR-001).
    6.  **Отсутствие идемпотентности:**
        -   Не реализована обработка заголовка `Idempotency-Key` для защиты от повторных запросов (ТЗ, раздел 21.5).
    7.  **Неструктурированная обработка ошибок:**
        -   Используются общие исключения `ValueError`, что затрудняет обработку на стороне клиента. ТЗ предписывает использовать коды ошибок, например `E-COUP-EXPIRED` (ТЗ, раздел 22.2).
- **Влияние:** Критическое. Основная бизнес-логика системы неполна и не соответствует требованиям. Это может привести к финансовым потерям (неправильно примененные скидки) и плохому пользовательскому опыту.

### 3.2. `CouponService` (Выдача купона)

- **Расположение:** `src/app/services/coupons.py`
- **Проблемы:**
    1.  **Отсутствие проверки условий выдачи:**
        -   Перед выдачей купона не проверяется, соответствует ли клиент условиям, заданным в `coupon_template.conditions` и `campaign` (например, проверка подписки на каналы) (ТЗ, UC-003, раздел 5.2).
    2.  **Некорректная генерация кода купона:**
        -   ТЗ (раздел 5.3) указывает, что префикс из двух кириллических букв должен задаваться кампанией. Текущая реализация берет его из `code_pattern` шаблона.
    3.  **Отсутствие расчета срока действия по `expiration_days`:**
        -   Дата истечения срока действия (`expires_at`) берется только из запроса, игнорируя поле `expiration_days` в шаблоне (ТЗ, раздел 9, таблица `coupon_templates`).
    4.  **Неструктурированная обработка ошибок:**
        -   Аналогично `RedemptionService`, используются `ValueError`.
- **Влияние:** Высокое. Купоны могут быть выданы клиентам, которые не соответствуют условиям акции.

## План доработок

На основе этого аудита будет построен план работ по приведению кода в соответствие с ТЗ. Приоритет будет отдан исправлениям в сервисах бизнес-логики.
